<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TV Display</title>
  <link rel="stylesheet" href="styles/tv.css">
</head>
<body>
  <div id="tv-display" class="tv-display"></div>
  

  <!-- Popups -->
  <div id="popup-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h3>Entrez votre nom</h3>
      <input type="text" id="username-input" placeholder="Votre nom" autocomplete="given-name">
      <div class="form-actions">
        <button class='btn-status-red' id="cancel-btn">Annuler</button>
        <button class='btn-status-green' id="submit-btn">Valider</button>
      </div>
    </div>
  </div>

  <div id="login-popup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h3>Connexion</h3>
      <input type="text" id="login-username" placeholder="Nom d'utilisateur">
      <input type="password" id="login-password" placeholder="Mot de passe">
      <div class="form-actions">
        <button class='btn-status-red' id="login-cancel-btn">Annuler</button>
        <button class='btn-status-green' id="login-submit-btn">Se connecter</button>
      </div>
    </div>
  </div>

  <div id="delete-card-popup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h3>Êtes-vous sûr de vouloir supprimer cette carte ?</h3>
      <div class="form-actions">
        <button class="btn-status-red" id="delete-card-cancel-btn">Annuler</button>
        <button class="btn-status-green" id="delete-card-confirm-btn">Supprimer</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const elements = {
        tvDisplay: document.getElementById('tv-display'),
        popups: {
          overlay: document.getElementById('popup-overlay'),
          login: document.getElementById('login-popup'),
          deleteCard: document.getElementById('delete-card-popup')
        },
        buttons: {
          submit: document.getElementById('submit-btn'),
          cancel: document.getElementById('cancel-btn'),
          loginSubmit: document.getElementById('login-submit-btn'),
          loginCancel: document.getElementById('login-cancel-btn'),
          deleteCardCancel: document.getElementById('delete-card-cancel-btn'),
          deleteCardConfirm: document.getElementById('delete-card-confirm-btn')
        }
      };

      const state = {
        currentCardId: null,
        cardToDelete: { columnId: null, cardId: null }
      };

      const config = {
        apiUrl: 'http://87.106.130.160/api',
        refreshInterval: 20000,
        pageReloadInterval: 600000,
        colors: {
          priority: {
            1: '#D4EDDA',
            2: '#A9DFBF',
            3: '#F9E79F',
            4: '#F5CBA7',
            5: '#F1948A'
          },
          columns: {
            'prepa-commande': '#B3E5FC',
            'stock': '#C8E6C9',
            'inter': '#FFF9C4',
            'rappel': '#fb8787'
          }
        }
      };

      const showLoginPopup = () => {
        elements.popups.login.style.display = 'flex';
      };

      elements.buttons.loginSubmit.addEventListener('click', async () => {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();

        if (username && password) {
          try {
            const response = await fetch(`${config.apiUrl}/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (response.ok) {
              localStorage.setItem('jwt_token', result.token);
              elements.popups.login.style.display = 'none';
              fetchColumns();
            } else {
              alert(result.message);
            }
          } catch (error) {
            console.error('Erreur lors de la connexion:', error);
          }
        }
      });

      elements.buttons.loginCancel.addEventListener('click', () => {
        elements.popups.login.style.display = 'none';
      });

      const fetchColumns = async () => {
        try {
          const token = localStorage.getItem('jwt_token');
          const response = await fetch(`${config.apiUrl}/columns`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const columns = await response.json();
          if (response.ok) {
            updateUI(columns);
          } else {
            if (response.status === 401|| response.status === 403) {
              showLoginPopup();
            }
          }
        } catch (error) {
          console.error('Erreur lors de la récupération des colonnes:', error);
          showLoginPopup();
        }
      };

      const deleteCard = async () => {
        try {
          const token = localStorage.getItem('jwt_token');
          await fetch(`${config.apiUrl}/cards/${state.cardToDelete.cardId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          fetchColumns();
        } catch (error) {
          console.error('Erreur lors de la suppression de la carte:', error);
          showLoginPopup();
        }
      };

      const updateCardStatus = async (cardId, newStatus) => {
        try {
          const token = localStorage.getItem('jwt_token');
          const response = await fetch(`${config.apiUrl}/cards/${cardId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (!response.ok) {
            throw new Error('Erreur lors de la mise à jour du statut');
          }

          fetchColumns();
        } catch (error) {
          console.error('Erreur lors de la mise à jour du statut de la carte:', error);
          showLoginPopup();
        }
      };

      const sortCards = (cards) => {
        return cards.sort((a, b) => b.priority - a.priority);
      };

      const updateUI = (columns) => {
        console.log('Updating UI...');
        elements.tvDisplay.innerHTML = ''; // Réinitialise l'affichage
        columns.forEach(column => {
          console.log(`Processing column: ${column.title}`);
          const columnElement = document.createElement('div');
          columnElement.className = 'column';
          columnElement.style.backgroundColor = 'white'; // Set column background to white

          const columnClass = column.title.replace(/\s+/g, '-').toLowerCase();
          columnElement.classList.add(columnClass);
          columnElement.style.border = `7px solid ${config.colors.columns[columnClass] || '#ccc'}`; // Set column border color

          const titleElement = document.createElement('h2');
          titleElement.innerText = column.title;
          titleElement.style.backgroundColor = config.colors.columns[columnClass] || '#ccc'; // Set title background color
          titleElement.style.borderRadius = '20px'; // Make the background oblong
          titleElement.style.padding = '10px'; // Add padding to the title
          titleElement.style.color = 'black'; // Set title text color to white

          columnElement.appendChild(titleElement);

          const cardsContainer = document.createElement('div');
          cardsContainer.className = 'cards';

          const sortedCards = sortCards(column.cards);
          sortedCards.forEach(card => {
            if (card.archived) return; // Skip archived cards
            console.log(`Processing card: ${card.title}`);
            const cardContainer = document.createElement('div');
            cardContainer.className = 'card-container';

            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.style.backgroundColor = config.colors.priority[card.priority];
            cardElement.innerHTML = `
              <h4 class="card-title">${card.title}</h4>
              <p class="card-content">${card.content}</p>
              <div class="card-footer">
                <button class="btn-status ${card.status === 'À faire' ? 'btn-status-red' : 'btn-status-green'}"><b>${card.status || '???'}</b></button>
                <div>
                  ${card.assigne !== 'Personne' ? `<p class="card-author">Assigné à : <b>${card.assigne}</b></p>` : ''}
                  <p class="card-author">Auteur : <b>${card.author || '???'}</b></p>
                </div>
              </div>
            `;

            if (card.link) {
              cardElement.style.cursor = 'pointer';
              cardElement.addEventListener('click', () => {
                window.open(card.link, '_blank');
              });
            }

            cardElement.querySelector('.btn-status').addEventListener('click', (e) => {
              e.stopPropagation();
              console.log(`Status button clicked for card ${card._id}...`);
              if (card.status === 'À faire') {
                console.log('Card is available. Showing popup...');
                elements.popups.overlay.style.display = 'flex';
                state.currentCardId = card._id;
              }
            });

            cardContainer.appendChild(cardElement);
            cardsContainer.appendChild(cardContainer);
          });

          // Logique de minimisation améliorée
          const calculateAndAdjustCards = () => {
            const viewportHeight = window.innerHeight;
            const columnTop = columnElement.getBoundingClientRect().top;
            const titleHeight = titleElement.offsetHeight;
            const padding = 20; // Padding entre les cartes
            const extraSpacePerCard = 5; // Espace supplémentaire par carte
            const availableHeight = viewportHeight - columnTop - titleHeight - 50; // 50px margin
            const cardContainers = cardsContainer.querySelectorAll('.card-container');
            const totalCardsHeight = Array.from(cardContainers).reduce((sum, container) => {
              return sum + container.scrollHeight;
            }, 0);

            // Si la hauteur totale dépasse l'espace disponible, on réduit toutes les cartes
            if (totalCardsHeight > availableHeight) {
              const numberOfCards = cardContainers.length;
              const newCardHeight = Math.min((availableHeight - (padding * (numberOfCards - 1))) / numberOfCards + extraSpacePerCard, 100); // Limite la hauteur maximale à 100px

              cardContainers.forEach(cardContainer => {
                cardContainer.style.height = `${newCardHeight}px`;
                cardContainer.classList.add('reduced');
              });

              // Forcer un recalcul du layout
              columnElement.style.display = 'none';
              columnElement.offsetHeight; // Force reflow
              columnElement.style.display = '';
            }
          };

          // Exécuter le calcul après un court délai pour s'assurer que le DOM est mis à jour
          setTimeout(calculateAndAdjustCards, 100);

          columnElement.appendChild(cardsContainer);
          elements.tvDisplay.appendChild(columnElement);

          // Attendre que toutes les images soient chargées avant de calculer
          Promise.all(Array.from(columnElement.getElementsByTagName('img'))
            .map(img => img.complete ? Promise.resolve() : new Promise(resolve => img.onload = resolve)))
            .then(() => {
              calculateAndAdjustCards();
            });
        });
        console.log('UI updated.');
      };

      elements.buttons.submit.addEventListener('click', () => {
        const username = document.getElementById('username-input').value.trim();
        console.log(`Submit button clicked. Username: ${username}, currentCardId: ${state.currentCardId}`);
        if (username && state.currentCardId) {
          updateCardStatus(state.currentCardId, `En cours : ${username}`);
          elements.popups.overlay.style.display = 'none';
          document.getElementById('username-input').value = '';
        }
      });

      elements.buttons.cancel.addEventListener('click', () => {
        console.log('Cancel button clicked.');
        elements.popups.overlay.style.display = 'none';
        document.getElementById('username-input').value = '';
      });

      elements.buttons.deleteCardCancel.addEventListener('click', () => {
        elements.popups.deleteCard.style.display = 'none';
      });

      elements.buttons.deleteCardConfirm.addEventListener('click', () => {
        deleteCard();
        elements.popups.deleteCard.style.display = 'none';
      });

      fetchColumns();
      setInterval(fetchColumns, config.refreshInterval);

      // Refresh the page every 10 minutes (600000 milliseconds)
      setInterval(() => {
        location.reload();
      }, config.pageReloadInterval);
    })();
  </script>
</body>
</html>